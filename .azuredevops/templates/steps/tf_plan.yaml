---

parameters:
  - name: tfCommandOptions
    type: string
    default: ''
  - name: tfPlanFilename
    type: string
    default: ''

steps:
  - task: Bash@3
    displayName: Get Terraform Plan Name
    inputs:
      targetType: 'inline'
      script: |
        planFile="${{ parameters.tfPlanFilename }}"
        if [ -z "$planFile" ]; then
          planFile="${ENVIRONMENT}.tfplan"
        fi
        echo "##vso[task.setvariable variable=PLAN_FILENAME]$planFile"

  - template: tf_init.yaml

  - task: TerraformTaskV4@4
    continueOnError: false
    displayName: Terraform Validate
    inputs:
      provider: azurerm
      command: validate
      workingDirectory: $(TF_DIRECTORY)

  - task: TerraformTaskV4@4
    name: TerraformPlan
    displayName: Terraform Plan - $(ENVIRONMENT) environment
    continueOnError: false

    inputs:
      provider: azurerm
      command: plan
      workingDirectory: $(TF_DIRECTORY)
      commandOptions: >-
        -input=false
        -var-file=$(tfVarsFile)
        ${{ parameters.tfCommandOptions }}
        -out=$(Build.ArtifactStagingDirectory)/$(PLAN_FILENAME)
      environmentServiceNameAzureRM: $(SERVICE_CONNECTION)

  - task: PublishBuildArtifacts@1
    displayName: Publish Artifact
    inputs:
      PathtoPublish: $(Build.ArtifactStagingDirectory)
      ArtifactName: $(TF_PLAN_ARTIFACT)
      publishLocation: Container
